





# 项目问题

# 杂项命令

## netstat -ntlp

这条命令的作用是列出所有正在监听 TCP 端口的进程以及它们的 PID 和名称。

## nslookup 

**nslookup** 是一个网络工具，用于查询域名系统 (DNS) 的记录。它可以用来查找特定域名的IP地址

# h_errno

h_errno错误可以用gai_strerror来获取错误信息

# const修饰指针（面试常考） 

![image-20240423111822336](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240423111822336.png)

执行任务相当于把任务加入到序列里，即基本工作+回调函数

# 登录业务

  

#  文件服务（上传网络）

采用多线程进行文件传输，主要目的不是为了加快传输速度（cpu一样），而是保证网络风险的减小，若是某个线程的网络断开，其他线程传输的依然有效

# 分块上传和下载

![image-20240423161001778](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240423161001778.png)

# 接口

![image-20240423161156385](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240423161156385.png)

# 哈希值设计

![image-20240423161305304](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240423161305304.png)

# json

![image-20240424090045168](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240424090045168.png)

可以用来遍历响应报文的内容

# get_packet_type获取报错类型

![image-20240424090404186](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240424090404186.png)

展示语法错误

# nginx部署静态资源服务器

![image-20240424151532546](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240424151532546.png)

![image-20240424151549064](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240424151549064.png)

![image-20240424151706112](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240424151706112.png)





## 数据库

## 唯一键约束

分库分表：解决数据流过大

垂直分片

主从复制：提升读的性能

水平分片：哈希值后两位

聚集函数：水平分片有缺点，不方便

MySQL支持事务

Redis不支持事务 

协程库

# 项目开始

## 1.用户类

token 拦截器

###    用来获取url信息（请求首行）![image-20240425084200909](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425084200909.png)

### 获取报文体（请求头这是encode模式的）

![image-20240425084253550](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425084253550.png)

![image-20240425101022863](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425101022863.png)



### rep->header();//获取请求头的信息

因为数据不保险，所以要备份

阿里云oss机制



# 2.文件类

瓶颈在网卡

# RabitMQ框架

![image-20240425134603588](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425134603588.png)

![image-20240425140512831](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425140512831.png)

表示成功

![image-20240425140609293](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425140609293.png)

![image-20240425140900776](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425140900776.png)

创建队列

![image-20240425141015310](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425141015310.png)

![image-20240425141055880](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425141055880.png)

安装容器(先创建挂载文件夹)

```c++
docker run -d --hostname rabbitsvr --name rabbit -p 5672:5672 -p 15672:15672 -p 25672:25672 -v /data/rabbitmq:/var/lib/rabbitmq rabbitmq:management

```

安装客户端

![image-20240425142003603](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425142003603.png)

依赖boost库

```c++
sudo apt-get update
sudo apt-get install libboost-all-dev

```



创建项目中所需要的交换器

![image-20240425142738210](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425142738210.png)

创建队列

![image-20240425142806179](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425142806179.png)

![image-20240425142858890](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425142858890.png)

![image-20240512143550125](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240512143550125.png)

# Docker技术

run通过镜像去启动

start通过已关闭的容器启动

stop关闭正在运行的容器

rm删除容器

rmi删除镜像

# Docker镜像制作

docker commit

docker build

# protobuf安装

```c++
tar -zxvf protobuf-3.20.1.tar.gz 

```

需要几个依赖包

```c++
sudo apt-get install autoconf automake libtool curl make g++ unzip

```

![image-20240425154257716](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425154257716.png)

## 把protobuf转化为c++

![image-20240425154812602](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425154812602.png)

![image-20240425160203478](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425160203478.png)

![image-20240425160440141](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425160440141.png)

![image-20240425160853567](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425160853567.png)

![image-20240425161036398](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425161036398.png)

![image-20240425161635278](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425161635278.png)

![image-20240425212413737](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425212413737.png)

ip和port是srpc框架自动确定的

# srpc基于workflow

# brpc性能最好

# grpc协议是http2.0

# srpc安装

# srpc使用

![image-20240425164902404](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425164902404.png)

# 安装consul1(主节点)

```c++
docker run --name consul1 -d -p 8500:8500 -p 8301:8301 -p 8302:8302 consul agent -server -bootstrap-expect 2 -ui -bind=0.0.0.0 -client=0.0.0.0

```

查看绑定端口信息

```c++
docker inspect --format '{{.NetworkSettings.IPAddress}}' consul1

```

建立集群

![image-20240425205222594](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425205222594.png)

```c++
docker run --name consul2 -d -p 8501:8500 consul agent -server -bind=0.0.0.0 -client=0.0.0.0 -join=172.17.0.3
```

同理建立集群

```c++
docker run --name consul3 -d -p 8502:8500 consul agent -server -bind=0.0.0.0 -client=0.0.0.0 -join=172.17.0.3
    
```

![image-20240425205541838](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425205541838.png)



表示成功

引入第三方库

![image-20240425210320522](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425210320522.png)

![image-20240425210433112](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240425210433112.png)

```c++
tar -zxvf ppconsul-0.2.3.tar.gz 
cd 
mkdir build && cd build
cmake ..
make
sudo make install
sudo ldconfig
    
```

![image-20240426082449041](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240426082449041.png)

默认以dc1为准

![image-20240426082541361](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240426082541361.png)

# 接入短信业务

```c++
#include <cstdlib>
#include <iostream>
#include <alibabacloud/core/AlibabaCloud.h>
#include <alibabacloud/core/CommonRequest.h>
#include <alibabacloud/core/CommonClient.h>
#include <alibabacloud/core/CommonResponse.h>

using namespace std;
using namespace AlibabaCloud;

int main( int argc, char** argv )
{
    AlibabaCloud::InitializeSdk();
    AlibabaCloud::ClientConfiguration configuration( "cn-shanghai" );
    // specify timeout when create client.
    configuration.setConnectTimeout(1500);
    configuration.setReadTimeout(4000);
    // Please ensure that the environment variables ALIBABA_CLOUD_ACCESS_KEY_ID and ALIBABA_CLOUD_ACCESS_KEY_SECRET are set.
    AlibabaCloud::Credentials credential( getenv("ALIBABA_CLOUD_ACCESS_KEY_ID"), getenv("ALIBABA_CLOUD_ACCESS_KEY_SECRET") );
    /* use STS Token
    credential.setSessionToken( getenv("ALIBABA_CLOUD_SECURITY_TOKEN") );
    */
    AlibabaCloud::CommonClient client( credential, configuration );
    AlibabaCloud::CommonRequest request(AlibabaCloud::CommonRequest::RequestPattern::RpcPattern);
    request.setHttpMethod(AlibabaCloud::HttpRequest::Method::Post);
    request.setDomain("dysmsapi.aliyuncs.com");
    request.setVersion("2017-05-25");
    request.setQueryParameter("Action", "SendSms");
    request.setQueryParameter("SignName", "阿里云短信测试");
    request.setQueryParameter("TemplateCode", "SMS_154950909");
    request.setQueryParameter("PhoneNumbers", "18552335201");
    request.setQueryParameter("TemplateParam", "{\"code\":\"1234\"}");

    auto response = client.commonResponse(request);
    if (response.isSuccess()) {
        printf("request success.\n");
        printf("result: %s\n", response.result().payload().c_str());
    } else {
        printf("error: %s\n", response.error().errorMessage().c_str());
        printf("request id: %s\n", response.error().requestId().c_str());
    }

    AlibabaCloud::ShutdownSdk();
    return 0;
}
```

参考文档

https://github.com/aliyun/aliyun-openapi-cpp-sdk.git

按照文档进行就行

记得环境变量设置

```c++
vim ~/.bashrc
添加一下两行到最后
    这个id和secret都是你本人的阿里云的信息
export ALIBABA_CLOUD_ACCESS_KEY_ID="ACCESS_KEY_ID"
export ALIBABA_CLOUD_ACCESS_KEY_SECRET="ACCESS_KEY_SECRET"
最后
# 使配置文件生效
source ~/.bash_profile
# 显示配置是否生效
echo $ALIBABA_CLOUD_ACCESS_KEY_ID
```

```html
编译
g++ t.cc --std=c++11 -lalibabacloud-sdk-core

```

```html
g++ test.cc -o -lworkflow -lwfrest -std=c++11 -lalibabacloud-sdk-core

```

```c++

```

![image-20240427180428224](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240427180428224.png)

![image-20240427182040995](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240427182040995.png)

```c++
g++ test.cc -lworkflow -lwfrest -std=c++11 -lalibabacloud-sdk-core -lcrypt

    //加入md5后的
    g++ test.cc -lworkflow -lwfrest -std=c++11 -lalibabacloud-sdk-core -lcrypt -lcrypto

```

![image-20240428115320037](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240428115320037.png)

需要加密及解密

# 文件类相关

# 检验token

1.快速鉴权---> 先检验token长度



# 下载转移（记得改一下参数)

![image-20240430152029585](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240430152029585.png)

![image-20240430153525041](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240430153525041.png)

这个页面也需要鉴权token

暂存代码

```c++
       //  读取文件内容 解析form-data类型的请求报文                                 
        using Form = std::map<std::string, std::pair<std::string, std::string>>;
        Form &form = req->form();
        std::pair<std::string, std::string> fileInfo = form["file"];
        std::pair<std::string, std::string> fileSha1 = form[fileInfo.first];
        //std::pair<std::string, std::string> token = form[fileInfo.first];
        fprintf(stderr,"fileSha1 = %s\n",fileSha1.second.c_str());//文件名对应的哈希>
        std::string filepath = "tmp/" + fileInfo.first;
        fprintf(stderr,"%s\n",filepath.c_str());
        fprintf(stderr,"%s\n",fileInfo.second.c_str());//文件内容
        resp->set_status_code("200");
 #if 0
        int fd = open(filepath.c_str(),O_RDWR|O_CREAT,0666);
        if(fd < 0){
             resp->set_status_code("500");
            return;
        }
         // try {} catch ()
         // 方案 1 write
         int ret = write(fd,fileInfo.second.c_str(),fileInfo.second.size());
 
       close(fd);
#endif

```

![image-20240504170325720](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240504170325720.png)

![image-20240512170259206](C:\Users\lushiji\AppData\Roaming\Typora\typora-user-images\image-20240512170259206.png)

























# 会议项目架构图

![architecture](R:\谷歌浏览器\architecture.png)